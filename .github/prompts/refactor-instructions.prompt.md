---
description: 'instructions ファイル内の重複ガイダンスを検出し、分類して統合リファクタを適用する'
agent: 'agent'
tools: ['search', 'read', 'edit/editFiles']
argument-hint: 'target: 重複チェック対象の *.instructions.md（例: .github/instructions/pr.instructions.md）。複数ならカンマ区切りで入力。'
---

# instructions 重複チェックとリファクタ適用

## 目的
指定された `*.instructions.md`（**1ファイル単位**）について、「同じ内容（重複）」を再現性ある基準で収集し、**有用な重複**と**不要な重複**に分類し、**不要な重複を削減する編集を常に適用**する。

## 入力
- ${input:target:重複チェック対象の instructions ファイルパス（複数可、カンマ区切り）}

## 入力検証
- `${input:target}` が空なら、対象ファイルパスの入力を依頼して停止する。
- `${input:target}` はカンマ区切りとして解釈し、前後の空白を除去する。
- 指定パスが存在しない/読めない場合は、その旨を明示し、代替候補（近いパス、検索で見つかった候補）を提示して停止する。

## 用語定義

### 「同じ内容（重複）」の判定レベル
本プロンプトでは **正規化一致 + 意味近似** で判定する（完全一致はその部分集合）。

1. **完全一致**
   - 同一の行/段落（空行区切り）/見出し配下の同一文が複数回出現

2. **正規化一致（デフォルト）**
   - 次の正規化後に同一とみなす
     - 箇条書き記号（`-` `*` `1.` 等）を除去
     - 連続空白を1つに
     - 行末の句点（`。` `.`）やコロン（`:` `：`）を除去
     - 強調記号（`**`）の除去
     - ラベル（`必須:` `推奨:` `禁止:` など）を除去（※ラベル差分が重要な場合は保持し、別グループとして扱う）

3. **意味近似**
   - 文言が異なるが、規範（何をすべき/してはいけない）が実質同一（言い換え、語順違い、同じ根拠の再掲など）

### 分類（有用な重複 / 不要な重複）
- **有用な重複（残す価値あり）**
  - U1: 局所性（見落としコストが高く、必要な場所に“短く”再掲する価値がある）
  - U2: 優先順位/衝突解決（別ルールと衝突しやすい箇所で「どれが勝つか」を再宣言している）
  - U3: 役割の違い（規範→例→チェックリスト等、同じ主題でも役割が異なる）

- **不要な重複（統合/削除対象）**
  - R1: 新しい決定情報（条件/例外/優先順位/成功条件/境界）が増えていない
  - R2: 同一スコープ（同じ章・同じ対象）での繰り返し
  - R3: 参照（「上記ルールに従う」）で置換できる
  - R4: 微妙な言い換えが増えて矛盾・分裂リスクを上げている

## 作業手順

### フェーズ1: 読込と構造化
1. #tool:read で `${input:target}` の各ファイルを読み込む（カンマ区切りを分割し、1つずつ処理する）。
2. 章構造（見出し階層）を抽出し、各セクションの「規範文」「根拠」「例」「チェックリスト」を区別する。
3. 次の単位で“候補文”を抽出する（優先順）
   - 箇条書きの1行
   - 「〜する」「〜しない」等の命令文
   - チェックボックス項目
   - 根拠（`**根拠**:` など）
   - 段落（空行区切り）

### フェーズ2: 重複収集
1. 完全一致・正規化一致・意味近似の順に、重複候補を収集する。
2. 出力は **「重複グループ」** としてまとめる（1グループ=1主題）。
3. 各グループに、**出現箇所（見出しパス）**と**短い抜粋**を添える。

### フェーズ3: 分類
1. 各グループを U1/U2/U3 と R1〜R4 で評価し、結論を付ける。
2. 有用な重複は「残す理由」と「残し方（短縮・合言葉化・役割分離）」を明記する。
3. 不要な重複は「統合先」「参照化」「削除」などの具体アクションを明記する。

### フェーズ4: リファクタ編集を常に適用
以下の方針で **#tool:edit/editFiles を必ず実行**し、対象ファイルを編集する。

- **規範（Rules）**は 1行1命令に寄せ、同じ主題を複数箇所で長文再掲しない
- 詳細（根拠・例）は該当章に集約し、規範本文のコピペを避ける
- チェックリストは「検査可能な表現」に変換し、原則文のコピーを避ける
- 章構造（見出し）を壊さない
- ルールの意味が変わる可能性がある箇所は、**本文を大きく変えず**に
  - 近い箇所へ統合する（短縮形へ）
  - または `TODO: 重複統合候補（要確認）` を付けて残す
  のいずれかを行い、編集自体は止めない

編集前に、必ず **変更方針サマリー**（どの重複グループをどこへ統合/短縮/参照化するか）を箇条書きで示す。

## 制約
- 外部リンクや外部文書を新規に参照しない（このファイル内容のみで判定する）
- “重複の削減”が目的化しない。安全性・運用性を落とす削除はしない
- 章構造（見出し）を壊さない
- 出力は日本語で行う
- 抜粋は短く（必要最小限）。長い引用は避ける

## 出力（必須）
各ファイルごとに以下を出力する。

1. **重複グループ一覧（要約）**
   - グループ名 / 分類（有用・不要） / 主な理由（U1/U2/U3 or R1〜R4） / 出現回数

2. **詳細**
   - グループごとに
     - 概要（何が同じか）
     - 出現箇所（見出しパス）
     - 抜粋（短い原文）
     - 判定（有用/不要）と根拠
     - 編集方針（統合/短縮/参照化/チェックリスト変換）

3. **編集結果**
   - 適用した変更点の要約（統合先、削除行数の目安、残した TODO の一覧）
