# カンバンTodoアプリ 実装計画

## 前提

- 既存の User CRUD 機能はテンプレートとして残す（参考実装として活用）
- 各フェーズの完了後にフォーマッター・リンター・テストを実行して品質を担保する
- 既存Userテンプレートはインメモリ配列だが、TaskはD1を使用するためusecaseはすべてasync関数となる
- ローカル環境での動作をゴールとする（Cloudflareへのデプロイはスコープ外）

## フェーズ 1: 共有型定義・データベースセットアップ

### 1-1. shared パッケージに Task 関連の型を追加 ✅ 完了済み

- `shared/src/types/model/task.ts` — `Status`, `Task` 型を定義
- `shared/src/types/api/task.ts` — API リクエスト/レスポンス型を定義
- `shared/src/index.ts` — 新しい型を re-export

### 1-2. D1 データベースのセットアップ ✅ 一部完了済み

- ✅ `backend/wrangler.jsonc` に D1 バインディングを追加済み
- ✅ `backend/db/migrations/0001_create_tasks_table.sql` にマイグレーションSQLを作成済み
- ⬜ Hono Bindings 型（`{ Bindings: { DB: D1Database } }`）を定義
- ⬜ `wrangler d1 migrations apply DB --local` でローカルにマイグレーション適用

> ※ Cloudflareへのデプロイはスコープ外。リモートD1作成（`wrangler d1 create`）と `database_id` の設定は不要。

## フェーズ 2: バックエンド API

### 2-0. バックエンドテスト基盤のセットアップ

- `@cloudflare/vitest-pool-workers` をインストール
- `backend/vitest.config.ts` を `defineWorkersConfig` を使った構成に書き換え
- D1 バインディング付きのテストが実行可能なことを確認

### 2-1. 共通ユーティリティの実装

- `backend/src/usecases/task/_tasks.ts` — `TaskRow` 型と `toTask()` マッピング関数（DB snake_case → モデル camelCase）

### 2-2. ユースケース層の実装

各ユースケースは D1 を使ってデータを操作する。

- `backend/src/usecases/task/get_usecase.ts` — 全タスク取得
- `backend/src/usecases/task/detail_usecase.ts` — タスク詳細取得
- `backend/src/usecases/task/create_usecase.ts` — タスク作成
- `backend/src/usecases/task/update_usecase.ts` — タスク更新
- `backend/src/usecases/task/delete_usecase.ts` — タスク削除
- `backend/src/usecases/task/move_usecase.ts` — ステータス・並び順変更

### 2-3. コントローラー層の実装

- `backend/src/controllers/task_controller.ts` — タスク用 Hono ルーター
- `backend/src/index.ts` にタスクルートを追加、Bindings 型定義、グローバルエラーハンドラ追加

### 2-4. バックエンドテスト

`@cloudflare/vitest-pool-workers` を使用してD1のローカルインスタンスでテストする。

- 各ユースケースの単体テスト
  - 正常系: CRUD操作が正しく動作すること
  - 異常系: 存在しないID、バリデーションエラー
- move_usecase のテスト
  - 同一カラム内移動、カラム間移動、先頭・末尾への移動
- コントローラーの統合テスト

## フェーズ 3: フロントエンド — データ取得・操作フック

### 3-1. タスク用サービスフックの実装

既存の汎用フック（`useGet`, `useCreate`, `useUpdate`, `useDelete`）を活用する。

- `frontend/src/pages/kanban/services/constants.ts` — API パス定数
- `frontend/src/pages/kanban/services/useTasks.ts` — タスク一覧取得
- `frontend/src/pages/kanban/services/useCreateTask.ts` — タスク作成
- `frontend/src/pages/kanban/services/useUpdateTask.ts` — タスク更新
- `frontend/src/pages/kanban/services/useDeleteTask.ts` — タスク削除
- `frontend/src/pages/kanban/services/useMoveTask.ts` — タスク移動（汎用フックを使わず、TanStack Query の楽観的更新パターンを直接実装）

### 3-2. MSW ハンドラーの追加

- `frontend/src/test/msw/handlers.ts` にタスク用ハンドラーを追加
- サービスフックのテストを作成

## フェーズ 4: フロントエンド — UI コンポーネント

### 4-1. dnd-kit ライブラリの導入

- `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities` をインストール

### 4-2. コンポーネントの実装

- `frontend/src/pages/kanban/components/TaskCard.tsx` — タスクカード
- `frontend/src/pages/kanban/components/KanbanColumn.tsx` — カンバンカラム
- `frontend/src/pages/kanban/components/TaskCreateModal.tsx` — 作成モーダル
- `frontend/src/pages/kanban/components/TaskEditModal.tsx` — 編集モーダル
- `frontend/src/pages/kanban/KanbanBoardPage.tsx` — カンバンボードページ

### 4-3. Storybook ストーリーの作成

- `TaskCard.stories.tsx`
- `KanbanColumn.stories.tsx`

### 4-4. DnD 統合テスト

- ドラッグ＆ドロップの動作テスト（カラム間移動、同一カラム内並び替え）
- 楽観的更新 + ロールバックのテスト

## フェーズ 5: ルーティング・統合

### 5-1. ルート定義の更新

- `frontend/src/routes/index/route.tsx` を更新してカンバンボードページを表示
- 既存の User 関連ルートはそのまま残す

### 5-2. 統合テスト

- カンバンボードの表示テスト（空のボード、タスクあり）
- タスク作成モーダルのフォーム送信テスト
- タスク削除確認ダイアログのテスト
- ドラッグ&ドロップの動作テスト

## フェーズ 6: 品質保証・仕上げ

### 6-1. 全体テストの実行

```bash
bun run biome:write
bun run typecheck
bun run test:run
```

### 6-2. ドキュメントの更新

- `README.md` の更新
- `copilot-instructions.md` のプロジェクト内容セクションを更新

## ファイル一覧（新規作成）

### shared

| ファイル                         | 説明                        |
| -------------------------------- | --------------------------- |
| `shared/src/types/model/task.ts` | Task, Status 型             |
| `shared/src/types/api/task.ts`   | API リクエスト/レスポンス型 |

### backend

| ファイル                                            | 説明                                |
| --------------------------------------------------- | ----------------------------------- |
| `backend/db/migrations/0001_create_tasks_table.sql` | テーブル作成マイグレーション        |
| `backend/src/usecases/task/_tasks.ts`               | TaskRow 型、toTask() マッピング関数 |
| `backend/src/usecases/task/get_usecase.ts`          | 全タスク取得                        |
| `backend/src/usecases/task/get_usecase.test.ts`     | 取得テスト                          |
| `backend/src/usecases/task/detail_usecase.ts`       | 詳細取得                            |
| `backend/src/usecases/task/create_usecase.ts`       | 作成                                |
| `backend/src/usecases/task/update_usecase.ts`       | 更新                                |
| `backend/src/usecases/task/delete_usecase.ts`       | 削除                                |
| `backend/src/usecases/task/move_usecase.ts`         | ステータス・並び順変更              |
| `backend/src/usecases/task/move_usecase.test.ts`    | move テスト                         |
| `backend/src/controllers/task_controller.ts`        | タスク用コントローラー              |
| `backend/src/controllers/task_controller.test.ts`   | コントローラーテスト                |

### frontend

| ファイル                                                   | 説明                 |
| ---------------------------------------------------------- | -------------------- |
| `frontend/src/pages/kanban/KanbanBoardPage.tsx`            | カンバンボードページ |
| `frontend/src/pages/kanban/components/TaskCard.tsx`        | タスクカード         |
| `frontend/src/pages/kanban/components/KanbanColumn.tsx`    | カンバンカラム       |
| `frontend/src/pages/kanban/components/TaskCreateModal.tsx` | 作成モーダル         |
| `frontend/src/pages/kanban/components/TaskEditModal.tsx`   | 編集モーダル         |
| `frontend/src/pages/kanban/services/constants.ts`          | API パス定数         |
| `frontend/src/pages/kanban/services/useTasks.ts`           | 一覧取得フック       |
| `frontend/src/pages/kanban/services/useCreateTask.ts`      | 作成フック           |
| `frontend/src/pages/kanban/services/useUpdateTask.ts`      | 更新フック           |
| `frontend/src/pages/kanban/services/useDeleteTask.ts`      | 削除フック           |
| `frontend/src/pages/kanban/services/useMoveTask.ts`        | 移動フック           |

## ファイル一覧（修正）

| ファイル                              | 変更内容                         |
| ------------------------------------- | -------------------------------- |
| `shared/src/index.ts`                 | Task 関連型の re-export 追加     |
| `backend/src/index.ts`                | タスクルート追加                 |
| `backend/wrangler.jsonc`              | D1 バインディング追加            |
| `frontend/src/routes/index/route.tsx` | カンバンボードページを表示に変更 |
| `frontend/src/test/msw/handlers.ts`   | タスク用 MSW ハンドラー追加      |
| `frontend/package.json`               | `@dnd-kit` 関連パッケージ追加    |
| `.github/copilot-instructions.md`     | プロジェクト内容の記載           |
