# カンバンTodoアプリ 仕様

## データモデル

### Task

| フィールド    | 型                                  | 説明                                                   |
| ------------- | ----------------------------------- | ------------------------------------------------------ |
| `id`          | `string`                            | UUID。タスクの一意識別子                               |
| `title`       | `string`                            | タスクのタイトル（1〜100文字、前後trim、空白のみ不可） |
| `description` | `string`                            | タスクの説明（0〜500文字、デフォルト空文字列）         |
| `status`      | `"todo" \| "in_progress" \| "done"` | タスクのステータス                                     |
| `order`       | `number`                            | カラム内での並び順（0始まり、昇順）                    |
| `createdAt`   | `string`                            | 作成日時（ISO 8601）                                   |
| `updatedAt`   | `string`                            | 更新日時（ISO 8601）                                   |

## データベーススキーマ

### tasks テーブル

```sql
CREATE TABLE tasks (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL DEFAULT '',
  status TEXT NOT NULL DEFAULT 'todo' CHECK (status IN ('todo', 'in_progress', 'done')),
  "order" INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_tasks_status ON tasks (status);
CREATE INDEX idx_tasks_status_order ON tasks (status, "order");
```

## API 仕様

ベースURL: `/tasks`

### エラーレスポンス共通形式

```json
{ "message": "string" }
```

| ステータスコード            | 用途                                              |
| --------------------------- | ------------------------------------------------- |
| `400 Bad Request`           | バリデーションエラー（title未指定、文字数超過等） |
| `404 Not Found`             | 指定IDのタスクが存在しない                        |
| `500 Internal Server Error` | 予期しないサーバーエラー                          |

### 一覧取得

- **GET** `/tasks`
- レスポンス: `{ tasks: Task[] }`
- ソート順: `ORDER BY status, "order" ASC`。フロントエンドがカラムごとに filter して使用する

### 詳細取得

- **GET** `/tasks/:id`
- レスポンス: `{ task: Task }`
- 編集モーダルを開く際に最新データを取得するために使用
- 存在しない場合: `404 Not Found`

### 作成

- **POST** `/tasks`
- リクエスト: `{ title: string, description?: string }`
- レスポンス: `{ task: Task }` （201 Created）
- 新規タスクは `status: "todo"` で作成される
- `id` は `crypto.randomUUID()` で生成（create_usecase 内で実行）
- `order` は同一ステータス内の `MAX(order) + 1`。タスクが存在しない場合は `0`
- `title` は前後trimされ、trim後1〜100文字であること。空白のみは 400
- `description` 未指定時は空文字列として保存。500文字超過は 400
- エラー: `400`（title未指定・空白のみ・文字数超過・description文字数超過）

### 更新

- **PUT** `/tasks/:id`
- リクエスト: `{ title?: string, description?: string }`
- レスポンス: `{ task: Task }`
- `title` が指定された場合: 前後trim → trim後1〜100文字、空白のみは 400
- `description` が指定された場合: 0〜500文字、超過は 400
- `title` も `description` も未指定の場合: 変更なしで現在のデータを返す
- `updated_at` を `datetime('now')` で更新する（D1には自動更新機構がないため手動）
- 存在しない場合: `404 Not Found`

### 削除

- **DELETE** `/tasks/:id`
- レスポンス: `{ message: string }`
- 削除後、同一カラムの残りタスクの order を 0 始まりの連番で振り直す（`db.batch()` で原子的に実行）
- 存在しない場合: `404 Not Found`

### ステータス・並び順の移動

- **PATCH** `/tasks/:id/move`
- リクエスト: `{ status: Status, order: number }`
- レスポンス: `{ task: Task }`
- ドラッグ&ドロップ操作に対応する専用エンドポイント- `updated_at` を `datetime('now')` で更新する
- バリデーション: `status` が有効値でない場合は 400、`order` が 0 未満または整数でない場合は 400
- `order` がカラム内のタスク数を超える場合は末尾に配置する- 存在しない場合: `404 Not Found`

#### order 再計算アルゴリズム

1. 対象タスクを元カラムから取り除く
2. 元カラムの残りタスクの order を 0 始まりの連番で振り直す
3. 移動先カラムで、指定 order の位置に対象タスクを挿入する
4. 移動先カラムの全タスクの order を 0 始まりの連番で振り直す
5. 上記の UPDATE は `db.batch()` で原子的に実行する（D1 は BEGIN/COMMIT 非対応のため）

**実装手順:**
1. `db.prepare()` で対象タスクと関連タスクを読み取る
2. アプリケーション層で新しい order を計算
3. `db.batch([...updateStatements])` で全 UPDATE を一括実行

**同一カラム内移動の場合:**

1. 対象タスクをリストから取り除く
2. 指定 order の位置に再挿入する
3. カラム内の全タスクの order を 0 始まりの連番で振り直す
4. `db.batch()` で原子的に実行

## 共有型定義（shared パッケージ）

### モデル型

```typescript
type Status = "todo" | "in_progress" | "done";

interface Task {
  id: string;
  title: string;
  description: string;
  status: Status;
  order: number;
  createdAt: string;
  updatedAt: string;
}
```

### API型

```typescript
interface GetTasksResponse {
  tasks: Task[];
}

interface GetTaskDetailResponse {
  task: Task;
}

interface CreateTaskRequest {
  title: string;
  description?: string;
}

interface CreateTaskResponse {
  task: Task;
}

interface UpdateTaskRequest {
  title?: string;
  description?: string;
}

interface UpdateTaskResponse {
  task: Task;
}

interface MoveTaskRequest {
  status: Status;
  order: number;
}

interface MoveTaskResponse {
  task: Task;
}

interface DeleteTaskResponse {
  message: string;
}

interface ErrorResponse {
  message: string;
}
```

## フロントエンド仕様

### 画面構成

#### カンバンボード（`/`）

- 3カラム（Todo / In Progress / Done）を横並びで表示
- 各カラムにはヘッダーとタスクカード一覧が表示される
- 各カラムのヘッダーにタスク数を表示
- タスクカードはドラッグ&ドロップでカラム間を移動可能
- カラム内での並び替えも可能
- 画面上部にタスク追加ボタンを配置

### コンポーネント構成

```
KanbanBoardPage
├── TaskCreateModal（タスク作成モーダル）
├── KanbanColumn（カラム）× 3
│   └── TaskCard（タスクカード）× n
└── TaskEditModal（タスク編集モーダル）
```

### タスクカード

- タイトルを表示
- 説明がある場合は省略表示（2行まで）
- クリックで編集モーダルを開く

### タスク作成モーダル

- タイトル（必須）、説明（任意）の入力フォーム
- 作成ボタン押下でタスクを作成し、Todoカラムに追加

### タスク編集モーダル

- タイトル、説明の編集フォーム
- 更新ボタンで保存
- 削除ボタンでタスクを削除（確認ダイアログあり）

### ドラッグ&ドロップ

- `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities` を使用
- 楽観的更新: ドロップ時にUIを即時反映し、バックグラウンドでAPIを呼び出す
- API失敗時はロールバックして元の状態に戻す

#### @dnd-kit コンポーネント構成

```
KanbanBoardPage
└─ DndContext (onDragStart, onDragOver, onDragEnd, sensors)
   ├─ KanbanColumn (useDroppable)
   │  └─ SortableContext (strategy: verticalListSortingStrategy)
   │     └─ TaskCard (useSortable)
   └─ DragOverlay
      └─ TaskCard (ドラッグ中の見た目用クローン)
```

**sensors:** `useSensors(useSensor(PointerSensor, { activationConstraint: { distance: 8 } }))`

#### フロントエンドでの order 決定

`onDragEnd` イベントから移動先の位置を計算する:

1. `over` がカラム（droppable）の場合: そのカラムの末尾に追加（`order = カラム内タスク数`）
2. `over` がタスク（sortable）の場合: そのタスクの位置に挿入（`order = overタスクのorder`）
3. バックエンドが order 再計算を行うため、フロントエンドは大まかな位置のみ伝える

#### 楽観的更新の実装方針

`useMoveTask` は汎用フックを使わず、TanStack Query の楽観的更新パターンを直接実装する。

**`onMutate` のキャッシュ操作手順:**

1. `queryClient.cancelQueries({ queryKey: ["tasks"] })` で進行中のフェッチをキャンセル
2. `queryClient.getQueryData<GetTasksResponse>(["tasks"])` で現在のキャッシュをスナップショット保存
3. キャッシュから対象タスクを抽出し、status/order を更新
4. 元カラム・移動先カラムのタスクの order を連番で振り直す
5. `queryClient.setQueryData(["tasks"], updatedData)` でUIに即時反映
6. スナップショットを return して context に渡す

**`onError`:** `queryClient.setQueryData(["tasks"], context.previousTasks)` でロールバック

**`onSettled`:** `queryClient.invalidateQueries({ queryKey: ["tasks"] })` でサーバーと同期

### ルーティング

| パス | ルートファイル           | ページコンポーネント |
| ---- | ------------------------ | -------------------- |
| `/`  | `routes/index/route.tsx` | `KanbanBoardPage`    |
## フロントエンド実装詳細

### queryKey 設計

| 用途       | queryKey        | 利用フック         |
| ---------- | --------------- | ------------------ |
| タスク一覧 | `["tasks"]`     | `useGetTasks`      |
| タスク詳細 | `["tasks", id]` | `useGetTaskDetail` |

### Hooks 使い分け

| 操作     | フック             | 実装                                      |
| -------- | ------------------ | ----------------------------------------- |
| 一覧取得 | `useGetTasks`      | 既存 `useGet` 汎用フックを使用            |
| 詳細取得 | `useGetTaskDetail` | 既存 `useGet` 汎用フックを使用            |
| 作成     | `useCreateTask`    | 既存 `useCreate` を使用                   |
| 更新     | `useUpdateTask`    | 既存 `useUpdate` を使用                   |
| 削除     | `useDeleteTask`    | 既存 `useDelete` を使用                   |
| 移動     | `useMoveTask`      | 楽観的更新のため `useMutation` を直接使用 |

### コンポーネント状態管理

`KanbanBoardPage` で管理するローカル状態:

| 状態                | 型               | 用途                                           |
| ------------------- | ---------------- | ---------------------------------------------- |
| `isCreateModalOpen` | `boolean`        | 作成モーダルの開閉                             |
| `editingTaskId`     | `string \| null` | 編集モーダルに表示するタスクID（nullで閉じる） |
| `activeId`          | `string \| null` | DragOverlay で表示するドラッグ中タスクID       |

### フォームバリデーション

Ant Design の `Form.Item` の `rules` で実装する。

| フィールド    | バリデーションルール                               |
| ------------- | -------------------------------------------------- |
| `title`       | `[{ required: true, whitespace: true, max: 100 }]` |
| `description` | `[{ max: 500 }]`                                   |

### MSW ハンドラ設計

`frontend/src/test/msw/handlers.ts` にタスク用ハンドラを追加する。インメモリ配列でタスクを保持し、CRUD + move 操作をエミュレートする。

### API エラーハンドリング

API エラー時はレスポンスの `message` フィールドを抽出し、Ant Design の `message.error()` で表示する。
## バックエンドアーキテクチャ

既存のレイヤー構造に準拠する。

```
controllers/
  task_controller.ts     -- ルーティングとバリデーション
usecases/task/
  get_usecase.ts         -- 一覧取得
  detail_usecase.ts      -- 詳細取得
  create_usecase.ts      -- 作成
  update_usecase.ts      -- 更新
  delete_usecase.ts      -- 削除
  move_usecase.ts        -- ステータス・並び順変更
```

### 既存Userテンプレートとの差異

既存のUser CRUDはインメモリ配列で同期処理だが、TaskはD1を使うため以下が異なる。

| 項目                | User（テンプレート） | Task（実装）                                       |
| ------------------- | -------------------- | -------------------------------------------------- |
| データソース        | インメモリ配列       | Cloudflare D1                                      |
| usecaseのシグネチャ | 同期関数             | `async` 関数（D1インスタンスを第一引数で受け取る） |
| controller          | `get_usecase()`      | `await get_usecase(c.env.DB)`                      |

### Hono Bindings 型定義

`backend/src/index.ts` に定義する。

```typescript
type Bindings = {
  DB: D1Database;
};

const app = new Hono<{ Bindings: Bindings }>();
```

controller では `c.env.DB` を取得して usecase に渡す。

### D1 バインディング

Hono の `Context` から `c.env.DB` で D1 データベースにアクセスする。
ローカル開発では `wrangler dev` が自動的にローカルSQLiteをD1として提供する。
マイグレーションは `wrangler d1 migrations apply DB --local` でローカルに適用する。

### DB → モデルマッピング

D1 のカラム名は snake_case だが、アプリケーションの共有型は camelCase のため、usecase 層で変換する。

```typescript
// backend/src/usecases/task/_tasks.ts に定義
interface TaskRow {
  id: string;
  title: string;
  description: string;
  status: string;
  order: number;
  created_at: string;
  updated_at: string;
}

function toTask(row: TaskRow): Task {
  return {
    id: row.id,
    title: row.title,
    description: row.description,
    status: row.status as Status,
    order: row.order,
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}
```

### SQL の `"order"` カラム

`order` は SQL の予約語のため、全ての SQL 文で `"order"` とダブルクォートで囲む。

### グローバルエラーハンドラ

```typescript
app.onError((err, c) => {
  console.error(err);
  return c.json({ message: "Internal Server Error" }, 500);
});
```

### バックエンドテスト基盤

`@cloudflare/vitest-pool-workers` を使用し、D1 バインディングを含むテストを実行する。

```typescript
// backend/vitest.config.ts
import { defineWorkersConfig } from "@cloudflare/vitest-pool-workers/config";

export default defineWorkersConfig({
  test: {
    poolOptions: {
      workers: {
        wrangler: { configPath: "./wrangler.jsonc" },
      },
    },
  },
});
```

## UI 状態別表示

| 状態           | 表示                                                         |
| -------------- | ------------------------------------------------------------ |
| ローディング中 | Ant Design の `Spin` コンポーネントを中央に表示              |
| エラー時       | Ant Design の `Alert` コンポーネントでエラーメッセージを表示 |
| データなし     | 「タスクがありません」のメッセージを表示                     |
